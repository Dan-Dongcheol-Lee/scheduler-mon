<!doctype html>
<html ng-app="myApp">
<head>
    <title>Scheduler mon</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/bootstrap-theme.css">
    <link rel="stylesheet" href="css/vis.css" />
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/angular.js"></script>
    <script src="js/angular-route.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/ui-bootstrap-tpls-0.11.0.js"></script>
    <script src="js/ng-service.js"></script>
    <script src="js/vis.js"></script>
    <script>
    function connectController($scope, $location, scheduler) {
        $scope.connect = function() {
            scheduler.connect($scope.host, $scope.port, function success(data) {
                $location.url('/mon');
            });
        }
    }

    function monController($scope, scheduler, $interval, $timeout) {
        scheduler.getTriggers(null, function success(data) {
            $scope.triggers = data;
        });

        scheduler.getJobs(null, function success(data) {
            $scope.jobs = data;
        });

        scheduler.getExecutingJobs(function success(data) {
            $scope.executingJobs = data;
        });

        var items;
        var timeline;

        $timeout(function() {
            scheduler.getTimeline(function success(timelines) {
                scheduler.getJobs(null, function success(jobs) {
                    loadTimeline(jobs, timelines);
                });
            });
        });

        function loadTimeline(jobs, timelines) {
          var groupId = 0;
          var groups = new vis.DataSet();
          _.each(jobs, function(job) {
            groups.add({id: ++groupId, content: job.name});
          });

          items = new vis.DataSet(timelines);
          var container = document.getElementById('schedule-timeline');
          var options = {
            showCurrentTime: true,
            start: new Date(Date.now() - 1000 * 60 * 60 * 24),
            height: '300px',
            min: new Date(2014, 5, 1),                // lower limit of visible range
            max: new Date(2015, 0, 1),                // upper limit of visible range
            zoomMin: 1000 * 60 * 60,                  // one hour in milliseconds
            zoomMax: 1000 * 60 * 60 * 24 * 31 * 3     // about three months in milliseconds
          };

          // create the timeline
          timeline = new vis.Timeline(container);
          timeline.setOptions(options);
          timeline.setGroups(groups);
          timeline.setItems(items);
        }
    }
    </script>
</head>
<body>
    <div class="container">

    <div id="error"></div>

    <div ng-view></div>

    <script type="text/ng-template" id="connect">
        <form name="form" class="form-horizontal" role="form">
            <div>
                <div class="form-group">
                    <h3>Welcome to scheduler mon.</h3>
                </div>
                <div class="form-group">
                    <label class="col-xs-2" for="host">host</label>
                    <input type="text" id="host" name="host" ng-model="host" class="col-sm-3 form-control"/>
                </div>
                <div class="form-group">
                    <label class="col-xs-2" for="port">port</label>
                    <input type="text" id="port" name="port" ng-model="port" class="col-sm-3 form-control"/>
                </div>
                <div class="form-actions">
                    <input type="button" class="btn btn-primary" name="submit" value="Connect" ng-click="connect()"/>
                </div>
            </div>
        </form>
    </script>

    <script type="text/ng-template" id="mon">
        <h2>Scheduler monitoring console</h2>
        <div class="row">
            <tabset>
                <tab heading="monitoring">
                    <form name="form">
                        <div id="schedule-timeline" style="height: 400px; margin-top: 20px; margin-bottom: 50px;"></div>
                        <h3>Triggers</h3>
                        <div class="row">
                            <table id="triggers-table" class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Group</th>
                                    <th>Name</th>
                                    <th>Previous fire time</th>
                                    <th>Next fire time</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="trigger in triggers">
                                    <td>{{trigger.group}}</td>
                                    <td>{{trigger.name}}</td>
                                    <td>{{trigger.previousFireTime}}</td>
                                    <td>{{trigger.nextFireTime}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row">
                            <table id="executing-jobs-table" class="table table-bordered">

                            </table>
                            {{executingJobs}}
                        </div>
                    </form>
                </tab>
                <tab heading="configuration">
                    <form name="form">
                        <h3>Jobs</h3>
                        <div class="row">
                            <table id="jobs-table" class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Group</th>
                                    <th>Name</th>
                                    <th>Job class name</th>
                                    <th>Job data map</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="job in jobs">
                                    <td>{{job.group}}</td>
                                    <td>{{job.name}}</td>
                                    <td>{{job.jobClassName}}</td>
                                    <td>{{job.jobDataMap}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </tab>
            </tabset>
        </div>

    </script>
    </div>
</body>
</html>